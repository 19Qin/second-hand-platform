<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¾³æ´²æ‰‹æœºå·APIæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        input, button { margin: 5px; padding: 8px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .result { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ‡¦ğŸ‡º æ¾³æ´²æ‰‹æœºå·APIæµ‹è¯•å·¥å…·</h1>
    
    <div class="test-section">
        <h3>APIåŸºåœ°å€é…ç½®</h3>
        <input type="text" id="baseUrl" value="http://localhost:8080/api/v1" placeholder="APIåŸºåœ°å€">
        <button onclick="testHealth()">æµ‹è¯•è¿æ¥</button>
        <div id="healthResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>1. å‘é€éªŒè¯ç </h3>
        <input type="text" id="smsPhone" value="0435497013" placeholder="æ‰‹æœºå·">
        <select id="smsType">
            <option value="register">æ³¨å†Œ</option>
            <option value="login">ç™»å½•</option>
        </select>
        <button onclick="sendSms()">å‘é€éªŒè¯ç </button>
        <div id="smsResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. ç”¨æˆ·æ³¨å†Œ</h3>
        <input type="text" id="regUsername" value="æ¾³æ´²æµ‹è¯•ç”¨æˆ·" placeholder="ç”¨æˆ·å">
        <input type="text" id="regMobile" value="0435497013" placeholder="æ‰‹æœºå·">
        <input type="password" id="regPassword" value="TestPassword123" placeholder="å¯†ç ">
        <input type="text" id="regSmsCode" placeholder="éªŒè¯ç ">
        <input type="text" id="regSmsId" placeholder="SMS ID">
        <button onclick="register()">æ³¨å†Œ</button>
        <div id="regResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. å¯†ç ç™»å½•</h3>
        <input type="text" id="loginMobile" value="0435497013" placeholder="æ‰‹æœºå·">
        <input type="password" id="loginPassword" value="TestPassword123" placeholder="å¯†ç ">
        <button onclick="loginWithPassword()">å¯†ç ç™»å½•</button>
        <div id="loginResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. çŸ­ä¿¡ç™»å½•</h3>
        <input type="text" id="smsLoginMobile" value="0435497013" placeholder="æ‰‹æœºå·">
        <input type="text" id="smsLoginCode" placeholder="éªŒè¯ç ">
        <input type="text" id="smsLoginId" placeholder="SMS ID">
        <button onclick="loginWithSms()">çŸ­ä¿¡ç™»å½•</button>
        <div id="smsLoginResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>5. æ‰‹æœºå·æ ¼å¼éªŒè¯</h3>
        <input type="text" id="validatePhone" placeholder="è¾“å…¥æ‰‹æœºå·æµ‹è¯•">
        <button onclick="validatePhone()">éªŒè¯æ ¼å¼</button>
        <div id="validateResult" class="result"></div>
        
        <h4>æµ‹è¯•ç”¨ä¾‹ï¼š</h4>
        <button onclick="testValidation('0435497013')">æ¾³æ´²04å·ç </button>
        <button onclick="testValidation('0567890123')">æ¾³æ´²05å·ç </button>
        <button onclick="testValidation('13800138000')">ä¸­å›½13å·ç </button>
        <button onclick="testValidation('0312345678')">æ— æ•ˆ03å·ç </button>
        <button onclick="testValidation('043549701')">æ— æ•ˆ9ä½</button>
    </div>

    <script>
        const phonePattern = /^(1[3-9]\d{9}|0[4-5]\d{8})$/;
        let currentTokens = {};

        function getBaseUrl() {
            return document.getElementById('baseUrl').value;
        }

        function showResult(elementId, content, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre class="${isSuccess ? 'success' : 'error'}">${JSON.stringify(content, null, 2)}</pre>`;
        }

        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(currentTokens.accessToken && {
                            'Authorization': `Bearer ${currentTokens.accessToken}`
                        })
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(`${getBaseUrl()}${endpoint}`, options);
                const result = await response.json();
                
                // ä¿å­˜token
                if (result.data && result.data.accessToken) {
                    currentTokens = {
                        accessToken: result.data.accessToken,
                        refreshToken: result.data.refreshToken
                    };
                }
                
                return result;
            } catch (error) {
                return { error: error.message };
            }
        }

        async function testHealth() {
            const result = await apiCall('/health');
            showResult('healthResult', result, !result.error);
        }

        async function sendSms() {
            const phone = document.getElementById('smsPhone').value;
            const type = document.getElementById('smsType').value;
            
            const result = await apiCall('/auth/sms/send', 'POST', {
                mobile: phone,
                type: type
            });
            
            if (result.data && result.data.smsId) {
                // è‡ªåŠ¨å¡«å…¥SMS ID
                if (type === 'register') {
                    document.getElementById('regSmsId').value = result.data.smsId;
                } else {
                    document.getElementById('smsLoginId').value = result.data.smsId;
                }
            }
            
            showResult('smsResult', result, !result.error);
        }

        async function register() {
            const data = {
                username: document.getElementById('regUsername').value,
                mobile: document.getElementById('regMobile').value,
                password: document.getElementById('regPassword').value,
                confirmPassword: document.getElementById('regPassword').value,
                smsCode: document.getElementById('regSmsCode').value,
                smsId: document.getElementById('regSmsId').value,
                agreeTerms: true
            };
            
            const result = await apiCall('/auth/register', 'POST', data);
            showResult('regResult', result, !result.error);
        }

        async function loginWithPassword() {
            const data = {
                mobile: document.getElementById('loginMobile').value,
                password: document.getElementById('loginPassword').value,
                rememberMe: true
            };
            
            const result = await apiCall('/auth/login/password', 'POST', data);
            showResult('loginResult', result, !result.error);
        }

        async function loginWithSms() {
            const data = {
                mobile: document.getElementById('smsLoginMobile').value,
                smsCode: document.getElementById('smsLoginCode').value,
                smsId: document.getElementById('smsLoginId').value
            };
            
            const result = await apiCall('/auth/login/sms', 'POST', data);
            showResult('smsLoginResult', result, !result.error);
        }

        function validatePhone() {
            const phone = document.getElementById('validatePhone').value;
            testValidation(phone);
        }

        function testValidation(phone) {
            document.getElementById('validatePhone').value = phone;
            
            const isValid = phonePattern.test(phone);
            const result = {
                phone: phone,
                isValid: isValid,
                length: phone.length,
                type: getPhoneType(phone),
                pattern: phonePattern.toString()
            };
            
            showResult('validateResult', result, isValid);
        }

        function getPhoneType(phone) {
            if (/^1[3-9]\d{9}$/.test(phone)) return 'ä¸­å›½æ‰‹æœºå·';
            if (/^0[4-5]\d{8}$/.test(phone)) return 'æ¾³æ´²æ‰‹æœºå·';
            return 'æœªçŸ¥æ ¼å¼';
        }

        // é¡µé¢åŠ è½½æ—¶æµ‹è¯•è¿æ¥
        window.onload = function() {
            testHealth();
        };
    </script>
</body>
</html>