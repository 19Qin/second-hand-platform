# 🚀 Fliliy 二手平台后端功能开发指南

## 📋 项目概述

**当前状态**: 用户认证模块已完成 ✅  
**下一阶段**: 商品管理 → 交易管理 → 聊天系统  
**开发优先级**: 按用户价值和技术依赖排序

---

## 🎯 功能开发路线图

### Phase 1: 商品管理模块 [优先级: 高]
- ✅ 用户认证 (已完成)
- 🔄 商品分类管理
- 🔄 商品发布功能
- 🔄 商品列表和搜索
- 🔄 商品详情展示
- 🔄 文件上传服务

### Phase 2: 交易管理模块 [优先级: 中]
- 🔄 交易咨询功能
- 🔄 线下交易确认
- 🔄 交易状态管理
- 🔄 交易记录查询

### Phase 3: 聊天系统模块 [优先级: 中]
- 🔄 聊天室创建
- 🔄 消息发送接收
- 🔄 文件传输
- 🔄 聊天记录管理

### Phase 4: 用户中心扩展 [优先级: 低]
- 🔄 用户资料管理
- 🔄 收藏功能
- 🔄 地址管理
- 🔄 消息通知

---

## 🛠️ Phase 1: 商品管理模块开发指南

### 1.1 数据库表设计

#### 商品分类表 (categories)
```sql
CREATE TABLE categories (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT '分类名称',
    icon VARCHAR(500) COMMENT '分类图标',
    parent_id BIGINT DEFAULT 0 COMMENT '父分类ID，0为顶级分类',
    sort_order INTEGER DEFAULT 0 COMMENT '排序权重',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_parent_id (parent_id),
    INDEX idx_sort_order (sort_order)
) COMMENT='商品分类表';
```

#### 商品表 (products)
```sql
CREATE TABLE products (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL COMMENT '商品标题',
    description TEXT COMMENT '商品描述',
    price DECIMAL(10,2) NOT NULL COMMENT '价格',
    original_price DECIMAL(10,2) COMMENT '原价',
    category_id BIGINT NOT NULL COMMENT '分类ID',
    seller_id BIGINT NOT NULL COMMENT '卖家ID',
    images JSON COMMENT '商品图片数组',
    main_image VARCHAR(500) COMMENT '主图片',
    condition_type VARCHAR(20) NOT NULL COMMENT '商品状况: NEW,LIKE_NEW,GOOD,FAIR,POOR',
    usage_info JSON COMMENT '使用信息: {type, value, unit}',
    warranty_info JSON COMMENT '保修信息',
    location_info JSON COMMENT '位置信息',
    tags JSON COMMENT '标签数组',
    status VARCHAR(20) DEFAULT 'ACTIVE' COMMENT '状态: ACTIVE,SOLD,INACTIVE',
    view_count INTEGER DEFAULT 0 COMMENT '浏览次数',
    favorite_count INTEGER DEFAULT 0 COMMENT '收藏次数',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_category_id (category_id),
    INDEX idx_seller_id (seller_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_price (price),
    FULLTEXT idx_title_desc (title, description)
) COMMENT='商品表';
```

#### 商品收藏表 (product_favorites)
```sql
CREATE TABLE product_favorites (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    product_id BIGINT NOT NULL COMMENT '商品ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_product (user_id, product_id),
    INDEX idx_user_id (user_id),
    INDEX idx_product_id (product_id)
) COMMENT='商品收藏表';
```

### 1.2 实体类设计

#### Product.java
```java
@Entity
@Table(name = "products")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Product {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, length = 200)
    private String title;
    
    @Column(columnDefinition = "TEXT")
    private String description;
    
    @Column(nullable = false, precision = 10, scale = 2)
    private BigDecimal price;
    
    @Column(name = "original_price", precision = 10, scale = 2)
    private BigDecimal originalPrice;
    
    @Column(name = "category_id", nullable = false)
    private Long categoryId;
    
    @Column(name = "seller_id", nullable = false)
    private Long sellerId;
    
    @Column(columnDefinition = "JSON")
    @Convert(converter = JsonStringListConverter.class)
    private List<String> images;
    
    @Column(name = "main_image")
    private String mainImage;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "condition_type", nullable = false)
    private ConditionType conditionType;
    
    @Column(name = "usage_info", columnDefinition = "JSON")
    @Convert(converter = JsonUsageInfoConverter.class)
    private UsageInfo usageInfo;
    
    @Column(name = "warranty_info", columnDefinition = "JSON")
    @Convert(converter = JsonWarrantyInfoConverter.class)
    private WarrantyInfo warrantyInfo;
    
    @Column(name = "location_info", columnDefinition = "JSON")
    @Convert(converter = JsonLocationInfoConverter.class)
    private LocationInfo locationInfo;
    
    @Column(columnDefinition = "JSON")
    @Convert(converter = JsonStringListConverter.class)
    private List<String> tags;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private ProductStatus status = ProductStatus.ACTIVE;
    
    @Column(name = "view_count")
    private Integer viewCount = 0;
    
    @Column(name = "favorite_count")
    private Integer favoriteCount = 0;
    
    @CreationTimestamp
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    public enum ConditionType {
        NEW, LIKE_NEW, GOOD, FAIR, POOR
    }
    
    public enum ProductStatus {
        ACTIVE, SOLD, INACTIVE
    }
}
```

#### Category.java
```java
@Entity
@Table(name = "categories")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Category {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, length = 50)
    private String name;
    
    @Column(length = 500)
    private String icon;
    
    @Column(name = "parent_id")
    private Long parentId = 0L;
    
    @Column(name = "sort_order")
    private Integer sortOrder = 0;
    
    @Column(name = "is_active")
    private Boolean isActive = true;
    
    @CreationTimestamp
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    @Transient
    private List<Category> children;
}
```

### 1.3 Repository 层

#### ProductRepository.java
```java
@Repository
public interface ProductRepository extends JpaRepository<Product, Long> {
    
    // 按状态查找商品
    Page<Product> findByStatus(ProductStatus status, Pageable pageable);
    
    // 按分类查找商品
    Page<Product> findByCategoryIdAndStatus(Long categoryId, ProductStatus status, Pageable pageable);
    
    // 按卖家查找商品
    Page<Product> findBySellerIdAndStatus(Long sellerId, ProductStatus status, Pageable pageable);
    
    // 全文搜索
    @Query(value = "SELECT * FROM products WHERE MATCH(title, description) AGAINST(:keyword IN NATURAL LANGUAGE MODE) AND status = :status", nativeQuery = true)
    Page<Product> searchByKeyword(@Param("keyword") String keyword, @Param("status") String status, Pageable pageable);
    
    // 价格区间查询
    Page<Product> findByPriceBetweenAndStatus(BigDecimal minPrice, BigDecimal maxPrice, ProductStatus status, Pageable pageable);
    
    // 更新浏览次数
    @Modifying
    @Query("UPDATE Product p SET p.viewCount = p.viewCount + 1 WHERE p.id = :id")
    void incrementViewCount(@Param("id") Long id);
    
    // 更新收藏次数
    @Modifying
    @Query("UPDATE Product p SET p.favoriteCount = p.favoriteCount + :increment WHERE p.id = :id")
    void updateFavoriteCount(@Param("id") Long id, @Param("increment") int increment);
}
```

#### CategoryRepository.java
```java
@Repository
public interface CategoryRepository extends JpaRepository<Category, Long> {
    
    // 查找顶级分类
    List<Category> findByParentIdAndIsActiveOrderBySortOrder(Long parentId, Boolean isActive);
    
    // 查找子分类
    List<Category> findByParentIdOrderBySortOrder(Long parentId);
    
    // 检查分类是否存在
    boolean existsByIdAndIsActive(Long id, Boolean isActive);
}
```

### 1.4 Service 层实现

#### ProductService.java
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class ProductService {
    
    private final ProductRepository productRepository;
    private final CategoryRepository categoryRepository;
    private final ProductFavoriteRepository favoriteRepository;
    private final FileService fileService;
    
    /**
     * 发布商品
     */
    @Transactional
    public Long publishProduct(PublishProductRequest request, Long sellerId) {
        // 1. 验证分类是否存在
        if (!categoryRepository.existsByIdAndIsActive(request.getCategoryId(), true)) {
            throw new BusinessException("商品分类不存在");
        }
        
        // 2. 验证图片数量
        if (request.getImages() == null || request.getImages().isEmpty()) {
            throw new BusinessException("至少需要上传一张商品图片");
        }
        
        if (request.getImages().size() > 20) {
            throw new BusinessException("商品图片最多20张");
        }
        
        // 3. 创建商品
        Product product = new Product();
        product.setTitle(request.getTitle());
        product.setDescription(request.getDescription());
        product.setPrice(request.getPrice());
        product.setOriginalPrice(request.getOriginalPrice());
        product.setCategoryId(request.getCategoryId());
        product.setSellerId(sellerId);
        product.setImages(request.getImages());
        product.setMainImage(request.getImages().get(0)); // 第一张为主图
        product.setConditionType(Product.ConditionType.valueOf(request.getCondition()));
        product.setUsageInfo(request.getUsageInfo());
        product.setWarrantyInfo(request.getWarranty());
        product.setLocationInfo(request.getLocation());
        product.setTags(request.getTags());
        
        Product saved = productRepository.save(product);
        
        log.info("Product published: id={}, title={}, seller={}", saved.getId(), saved.getTitle(), sellerId);
        
        return saved.getId();
    }
    
    /**
     * 获取商品列表
     */
    public PagedResponse<ProductSummaryResponse> getProducts(ProductQueryRequest request) {
        // 构建查询条件
        Specification<Product> spec = buildProductSpecification(request);
        
        // 构建排序
        Sort sort = buildSort(request.getSort());
        Pageable pageable = PageRequest.of(request.getPage() - 1, request.getSize(), sort);
        
        // 执行查询
        Page<Product> products = productRepository.findAll(spec, pageable);
        
        // 转换为响应对象
        List<ProductSummaryResponse> summaries = products.getContent().stream()
                .map(this::convertToSummaryResponse)
                .collect(Collectors.toList());
        
        return PagedResponse.of(summaries, products);
    }
    
    /**
     * 获取商品详情
     */
    @Transactional
    public ProductDetailResponse getProductDetail(Long productId, Long currentUserId) {
        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new BusinessException("商品不存在"));
        
        // 增加浏览次数
        productRepository.incrementViewCount(productId);
        
        // 检查是否收藏
        boolean isFavorited = false;
        if (currentUserId != null) {
            isFavorited = favoriteRepository.existsByUserIdAndProductId(currentUserId, productId);
        }
        
        // 构建响应
        return convertToDetailResponse(product, isFavorited, currentUserId);
    }
    
    /**
     * 收藏/取消收藏商品
     */
    @Transactional
    public FavoriteResponse toggleFavorite(Long productId, Long userId) {
        // 检查商品是否存在
        Product product = productRepository.findById(productId)
                .orElseThrow(() -> new BusinessException("商品不存在"));
        
        // 检查是否已收藏
        Optional<ProductFavorite> existingFavorite = favoriteRepository
                .findByUserIdAndProductId(userId, productId);
        
        boolean isFavorited;
        if (existingFavorite.isPresent()) {
            // 取消收藏
            favoriteRepository.delete(existingFavorite.get());
            productRepository.updateFavoriteCount(productId, -1);
            isFavorited = false;
        } else {
            // 添加收藏
            ProductFavorite favorite = new ProductFavorite();
            favorite.setUserId(userId);
            favorite.setProductId(productId);
            favoriteRepository.save(favorite);
            productRepository.updateFavoriteCount(productId, 1);
            isFavorited = true;
        }
        
        // 获取最新收藏数
        int favoriteCount = favoriteRepository.countByProductId(productId);
        
        FavoriteResponse response = new FavoriteResponse();
        response.setIsFavorited(isFavorited);
        response.setFavoriteCount(favoriteCount);
        
        return response;
    }
    
    // ... 其他方法实现
}
```

### 1.5 Controller 层实现

#### ProductController.java
```java
@RestController
@RequestMapping("/products")
@RequiredArgsConstructor
@Slf4j
public class ProductController {
    
    private final ProductService productService;
    
    /**
     * 发布商品
     */
    @PostMapping
    @PreAuthorize("hasRole('USER')")
    public ApiResponse<PublishProductResponse> publishProduct(
            @Valid @RequestBody PublishProductRequest request,
            @AuthenticationPrincipal UserDetails userDetails) {
        
        Long sellerId = Long.valueOf(userDetails.getUsername());
        Long productId = productService.publishProduct(request, sellerId);
        
        PublishProductResponse response = new PublishProductResponse();
        response.setProductId(productId.toString());
        response.setStatus("ACTIVE");
        response.setPublishTime(LocalDateTime.now());
        
        return ApiResponse.success("发布成功", response);
    }
    
    /**
     * 获取商品列表
     */
    @GetMapping
    public ApiResponse<PagedResponse<ProductSummaryResponse>> getProducts(
            @Valid ProductQueryRequest request,
            @AuthenticationPrincipal UserDetails userDetails) {
        
        Long currentUserId = userDetails != null ? Long.valueOf(userDetails.getUsername()) : null;
        PagedResponse<ProductSummaryResponse> response = productService.getProducts(request);
        
        return ApiResponse.success("获取成功", response);
    }
    
    /**
     * 获取商品详情
     */
    @GetMapping("/{productId}")
    public ApiResponse<ProductDetailResponse> getProductDetail(
            @PathVariable Long productId,
            @AuthenticationPrincipal UserDetails userDetails) {
        
        Long currentUserId = userDetails != null ? Long.valueOf(userDetails.getUsername()) : null;
        ProductDetailResponse response = productService.getProductDetail(productId, currentUserId);
        
        return ApiResponse.success("获取成功", response);
    }
    
    /**
     * 收藏/取消收藏商品
     */
    @PostMapping("/{productId}/favorite")
    @PreAuthorize("hasRole('USER')")
    public ApiResponse<FavoriteResponse> toggleFavorite(
            @PathVariable Long productId,
            @AuthenticationPrincipal UserDetails userDetails) {
        
        Long userId = Long.valueOf(userDetails.getUsername());
        FavoriteResponse response = productService.toggleFavorite(productId, userId);
        
        String message = response.getIsFavorited() ? "收藏成功" : "取消收藏成功";
        return ApiResponse.success(message, response);
    }
}
```

### 1.6 文件上传服务

#### FileService.java
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class FileService {
    
    @Value("${app.upload.path:/api/v1/files/}")
    private String uploadPath;
    
    @Value("${app.upload.max-size:10MB}")
    private String maxFileSize;
    
    /**
     * 上传商品图片
     */
    public UploadResponse uploadProductImage(MultipartFile file) {
        // 1. 验证文件
        validateImageFile(file);
        
        // 2. 生成文件名
        String filename = generateFilename(file.getOriginalFilename());
        String relativePath = "products/" + filename;
        
        try {
            // 3. 保存文件
            Path targetPath = Paths.get(uploadPath, relativePath);
            Files.createDirectories(targetPath.getParent());
            Files.copy(file.getInputStream(), targetPath, StandardCopyOption.REPLACE_EXISTING);
            
            // 4. 生成访问URL
            String url = "/api/v1/files/" + relativePath;
            
            // 5. 构建响应
            UploadResponse response = new UploadResponse();
            response.setUrl(url);
            response.setFilename(filename);
            response.setSize(file.getSize());
            response.setUploadTime(LocalDateTime.now());
            
            log.info("File uploaded: {}", relativePath);
            return response;
            
        } catch (IOException e) {
            log.error("File upload failed: {}", e.getMessage());
            throw new BusinessException("文件上传失败");
        }
    }
    
    private void validateImageFile(MultipartFile file) {
        if (file.isEmpty()) {
            throw new BusinessException("文件不能为空");
        }
        
        // 检查文件类型
        String contentType = file.getContentType();
        if (contentType == null || !contentType.startsWith("image/")) {
            throw new BusinessException("只支持图片文件");
        }
        
        // 检查文件大小 (10MB)
        if (file.getSize() > 10 * 1024 * 1024) {
            throw new BusinessException("文件大小不能超过10MB");
        }
    }
    
    private String generateFilename(String originalFilename) {
        String extension = StringUtils.getFilenameExtension(originalFilename);
        return System.currentTimeMillis() + "_" + UUID.randomUUID().toString().substring(0, 8) + "." + extension;
    }
}
```

---

## 📝 开发实施步骤

### Step 1: 创建数据库表
```bash
# 运行SQL脚本创建商品相关表
mysql -u root -p fliliy_db < create_product_tables.sql
```

### Step 2: 创建实体类和DTO
1. 创建 Product.java、Category.java 实体类
2. 创建 PublishProductRequest.java、ProductQueryRequest.java 等DTO
3. 创建 ProductSummaryResponse.java、ProductDetailResponse.java 等响应类

### Step 3: 实现Repository层
1. ProductRepository.java
2. CategoryRepository.java  
3. ProductFavoriteRepository.java

### Step 4: 实现Service层
1. ProductService.java - 核心业务逻辑
2. CategoryService.java - 分类管理
3. FileService.java - 文件上传

### Step 5: 实现Controller层
1. ProductController.java - 商品相关接口
2. CategoryController.java - 分类接口
3. FileController.java - 文件上传接口

### Step 6: 编写测试用例
1. ProductServiceTest.java
2. ProductControllerTest.java
3. 集成测试

### Step 7: 接口测试验证
使用你现有的测试手册验证新接口功能

---

## 🔍 测试验证清单

### 商品管理功能测试
- [ ] 商品分类查询
- [ ] 商品图片上传  
- [ ] 商品发布
- [ ] 商品列表查询（分页、搜索、筛选）
- [ ] 商品详情查看
- [ ] 商品收藏功能
- [ ] 商品编辑和下架

### 性能测试
- [ ] 商品列表查询性能
- [ ] 图片上传性能
- [ ] 数据库查询优化

---

## 📞 技术支持

**开发优先级**: 商品管理 → 交易管理 → 聊天系统  
**预计开发周期**: 商品管理模块 2-3周  
**文档更新**: 2025-09-02

开发过程中如有问题，可参考已实现的认证模块代码结构。