# 交易模块重构说明

**日期**: 2025-09-30  
**版本**: v2.0  
**状态**: ✅ 已完成

---

## 一、重构背景

### 原有问题
1. 买家点击"咨询"就立即创建Transaction记录，时机过早
2. 发送的只是普通TEXT消息，卖家无法识别这是交易意向
3. 卖家端收不到明确的交易申请通知
4. 需要填写过多地点、联系方式等信息（应在聊天中协商）

### 解决方案
- 交易记录创建时机延后到"发起交易申请"
- 增加交易申请专用消息类型（TRANSACTION_REQUEST）
- 交易码每24小时自动刷新（不再过期失效）
- 简化交易流程，地点信息在聊天中协商

---

## 二、数据库变更

### 1. transactions表
```sql
-- 新增字段
ALTER TABLE transactions
ADD COLUMN request_by BIGINT COMMENT '交易申请发起方',
ADD COLUMN requested_at TIMESTAMP COMMENT '交易申请发起时间',
ADD COLUMN responded_at TIMESTAMP COMMENT '交易申请响应时间',
ADD COLUMN reject_reason VARCHAR(500) COMMENT '拒绝原因',
ADD COLUMN code_refresh_count INT DEFAULT 0 COMMENT '交易码刷新次数';

-- 修改状态枚举
ALTER TABLE transactions 
MODIFY COLUMN status ENUM('INQUIRY','PENDING','AGREED','COMPLETED','REJECTED','CANCELLED','EXPIRED');
```

### 2. chat_messages表
```sql
-- 新增字段
ALTER TABLE chat_messages
ADD COLUMN transaction_id BIGINT COMMENT '关联的交易ID',
ADD COLUMN inquiry_type VARCHAR(20) COMMENT '交易意向类型';

-- 修改消息类型枚举
ALTER TABLE chat_messages
MODIFY COLUMN message_type ENUM('TEXT','IMAGE','VOICE','SYSTEM','PRODUCT_CARD','TRANSACTION_REQUEST','TRANSACTION_RESPONSE');
```

---

## 三、新增API接口

### 1. POST /api/v1/transactions/request
**功能**: 发起交易申请  
**状态**: ✅ 已实现  
**Controller**: TransactionController.createTransactionRequest()

**请求参数**:
```json
{
  "chatRoomId": 123456,
  "productId": 789,
  "message": "我想购买"
}
```

**响应**:
```json
{
  "code": 200,
  "data": {
    "transactionId": "tx_123456",
    "status": "PENDING",
    "requestedAt": "2025-09-30 10:00:00"
  }
}
```

### 2. POST /api/v1/transactions/{transactionId}/respond
**功能**: 响应交易申请（同意/拒绝）  
**状态**: ✅ 已实现  
**Controller**: TransactionController.respondToTransactionRequest()

**请求参数（同意）**:
```json
{
  "action": "AGREE"
}
```

**响应（同意）**:
```json
{
  "code": 200,
  "data": {
    "transactionId": "tx_123456",
    "status": "AGREED",
    "transactionCode": "1234",
    "codeExpiresAt": "2025-10-01 10:00:00",
    "note": "请在线下交易时向卖家提供此交易码"
  }
}
```

---

## 四、废弃的接口

⚠️ 以下接口已废弃，请使用新接口：

| 废弃接口 | 替代接口 |
|---------|---------|
| `POST /transactions/inquiry` | `POST /transactions/request` |
| `POST /transactions/{id}/agree-offline` | `POST /transactions/{id}/respond` |

---

## 五、新的交易流程

```
1. 聊天咨询
   买家/卖家在聊天中讨论商品细节
   
2. 发起交易申请
   POST /transactions/request
   → 创建Transaction（PENDING）
   → 发送TRANSACTION_REQUEST消息
   
3. 响应交易申请
   POST /transactions/{id}/respond
   【同意】→ 生成交易码（AGREED）
   【拒绝】→ 状态变为REJECTED
   
4. 线下交易
   买家口头告知卖家交易码
   
5. 完成交易
   POST /transactions/{id}/complete
   → 输入交易码
   → 状态变为COMPLETED
   → 商品变为SOLD
```

---

## 六、定时任务

### 交易码自动刷新
- **执行时间**: 每天凌晨1点
- **功能**: 刷新所有AGREED状态交易的交易码
- **文件**: TransactionCodeRefreshTask.java
- **状态**: ✅ 已实现

```java
@Scheduled(cron = "0 0 1 * * ?")
public void refreshExpiredTransactionCodes() {
    // 查找status=AGREED且交易码即将过期的交易
    // 生成新的4位交易码
    // code_refresh_count + 1
}
```

---

## 七、WebSocket消息

### 1. 交易申请消息（TRANSACTION_REQUEST）
卖家收到此消息后，应显示"同意/拒绝"按钮

```json
{
  "type": "TRANSACTION_REQUEST",
  "transactionId": 456789,
  "inquiryType": "PURCHASE",
  "content": "我想购买这个商品",
  "relatedProductId": 999
}
```

### 2. 交易同意消息（SYSTEM）
```json
{
  "type": "SYSTEM",
  "systemType": "TRANSACTION_AGREED",
  "content": "交易申请已同意，交易码已生成",
  "transactionId": 456789
}
```

### 3. 交易拒绝消息（SYSTEM）
```json
{
  "type": "SYSTEM",
  "systemType": "TRANSACTION_REJECTED",
  "content": "交易申请已被拒绝：商品已售出",
  "transactionId": 456789
}
```

---

## 八、代码文件清单

### 已修改的文件
1. ✅ Transaction.java - 实体类新增字段
2. ✅ ChatMessage.java - 实体类新增字段
3. ✅ TransactionRepository.java - 新增查询方法
4. ✅ TransactionService.java - 新增业务方法
5. ✅ ChatService.java - 新增消息发送方法
6. ✅ TransactionController.java - 新增接口
7. ✅ SecondHandApplication.java - 启用定时任务

### 新增的文件
8. ✅ TransactionRequestRequest.java - DTO
9. ✅ TransactionRespondRequest.java - DTO
10. ✅ TransactionRequestResponse.java - DTO
11. ✅ TransactionRespondResponse.java - DTO
12. ✅ TransactionCodeRefreshTask.java - 定时任务

---

## 九、测试建议

### 1. 单元测试
- [ ] 发起交易申请
- [ ] 响应交易申请（同意）
- [ ] 响应交易申请（拒绝）
- [ ] 完成交易（验证交易码）
- [ ] 权限验证

### 2. 集成测试
- [ ] 完整交易流程（PENDING → AGREED → COMPLETED）
- [ ] WebSocket消息推送
- [ ] 交易码刷新定时任务

### 3. 前端对接
- [ ] 买家端：发起交易按钮
- [ ] 卖家端：交易申请卡片（同意/拒绝按钮）
- [ ] 买家端：显示交易码
- [ ] 卖家端：输入交易码完成交易

---

## 十、部署注意事项

1. **数据库迁移**: 先执行SQL脚本
2. **向后兼容**: 已将现有INQUIRY状态数据迁移为PENDING
3. **定时任务**: 确保@EnableScheduling已启用
4. **重启服务**: 完成部署后重启后端服务

---

**重构完成时间**: 2025-09-30  
**文档维护人**: AI Assistant